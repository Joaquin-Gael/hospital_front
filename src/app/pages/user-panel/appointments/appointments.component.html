<section
  class="appointments"
  [ngClass]="{
    'appointments--loading': loading,
    'appointments--loaded': !loading
  }"
>
  @if (loading) {
    <app-loading-spinner [message]="'Cargando turnos...'"></app-loading-spinner>
  } @else {
    <div class="appointments__grid">
      @for (appointment of filteredAppointments; track trackById($index, appointment)) {
        <div class="appointment-card">
          <div class="appointment-card__header">
            <div class="appointment-card__date">
              <span class="appointment-card__day-name">
                {{ getDayName(appointment.date) }}
              </span>

              <span class="appointment-card__day">
                {{ getDayNumber(appointment.date) }}
              </span>

              <span class="appointment-card__month">
                {{ getMonthName(appointment.date) }}
              </span>
            </div>

            <div class="appointment-card__time">
              <svg
                class="icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>

              {{ appointment.time }}
            </div>
          </div>

          <div class="appointment-card__body">
            <h3 class="appointment-card__specialty">
              {{ appointment.specialty }}
            </h3>

            <div class="appointment-card__doctor">
              <svg
                class="icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                />
              </svg>

              Doctor: {{ appointment.doctorName }}
            </div>

            <!--
            <div class="appointment-card__location">
              <svg
                class="icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
            </div>
            -->

            <div class="appointment-card__status">
              <span
                class="status-badge"
                [ngClass]="{
                  'status-waiting': appointment.state === 'waiting',
                  'status-completed': appointment.state === 'finished',
                  'status-cancelled': appointment.state === 'cancelled'
                }"
              >
                {{ appointment.state | titlecase }}
              </span>
            </div>

            <div
              class="appointment-card__payment"
              role="region"
              aria-label="Información de pago"
            >
              <div class="appointment-card__payment-header">
                <span class="appointment-card__section-title">Pago</span>
                <span
                  class="payment-status"
                  [ngClass]="getPaymentStatusClass(appointment.paymentStatus)"
                  aria-live="polite"
                >
                  {{ getPaymentStatusLabel(appointment.paymentStatus) }}
                </span>
              </div>

              @if (appointment.paymentUrl) {
                <a
                  class="payment-link"
                  [href]="appointment.paymentUrl"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  Completar pago
                  <span class="visually-hidden">(abre en una nueva pestaña)</span>
                </a>
              } @else {
                <p class="payment-text" role="note">
                  No hay enlace de pago disponible.
                </p>
              }

              @if (shouldShowResumePayment(appointment)) {
                <button
                  class="btn btn--primary btn--sm payment-resume-button"
                  type="button"
                  (click)="onResumePayment(appointment)"
                  [disabled]="isPaymentRetrying(appointment.turnId)"
                >
                  @if (isPaymentRetrying(appointment.turnId)) {
                    <span class="button-spinner" aria-hidden="true"></span>
                    Reintentando...
                  } @else {
                    Reanudar pago
                  }
                </button>
              }

              <div
                class="appointment-card__metadata"
                aria-label="Detalles de pago"
              >
                @if (
                  appointment.paymentMethod ||
                  appointment.paymentMetadataEntries.length > 0
                ) {
                  <dl class="metadata-list">
                    @if (appointment.paymentMethod) {
                      <div class="metadata-list__item">
                        <dt>Método</dt>
                        <dd>
                          {{ getPaymentMethodLabel(appointment.paymentMethod) }}
                        </dd>
                      </div>
                    }

                    @for (
                      item of appointment.paymentMetadataEntries;
                      track item.label + item.value
                    ) {
                      <div class="metadata-list__item">
                        <dt>{{ item.label }}</dt>
                        <dd>{{ item.value }}</dd>
                      </div>
                    }
                  </dl>
                } @else {
                  <p class="payment-text" role="note">
                    No hay información de pago adicional.
                  </p>
                }
              </div>
            </div>
          </div>

          <div class="appointment-card__footer">
            <button
              class="btn btn--outline btn--sm"
              (click)="onReschedule(appointment.turnId)"
              [disabled]="appointment.state !== 'waiting'"
            >
              Reprogramar
            </button>

            <button
              class="btn btn--danger btn--sm"
              (click)="onCancel(appointment.turnId)"
              [disabled]="appointment.state !== 'waiting'"
            >
              Cancelar
            </button>
          </div>
        </div>
      } @empty {
        <div class="appointments__empty">
          <div class="empty-state">
            <div class="empty-state__icon">
              <svg
                class="icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
            </div>

            <h2>No hay turnos agendados</h2>

            <p>Agenda un nuevo turno para comenzar.</p>

            <button class="btn btn--primary" (click)="onNewAppointment()">
              Agendar turno
            </button>
          </div>
        </div>
      }
    </div>
  }
</section>