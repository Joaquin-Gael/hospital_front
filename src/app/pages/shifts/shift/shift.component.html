<app-hero [heroData]="heroData"></app-hero>
<div class="appointment-scheduler-container" @fadeInOut>
  <div class="appointment-card">
    <!-- Encabezado -->
    <div class="card-header">
      <h2 class="appointment-title">
        <span class="title-icon" @rotateIcon>
          <i class="material-icons">event_available</i>
        </span>
        <span class="title-text">Reserva tu turno</span>
      </h2>

      <!-- Indicador de pasos -->
      <app-step-indicator
        [currentStep]="currentStep"
        [totalSteps]="totalSteps"
        (stepChange)="goToStep($event)"
      ></app-step-indicator>
    </div>

    <div *ngIf="paymentStatus" class="payment-status-banner">
      <span class="status-badge" [ngClass]="paymentStatus">
        {{ getPaymentStatusLabel(paymentStatus) }}
      </span>
      <p
        *ngIf="paymentStatus === PaymentStatus.PENDING || paymentStatus === PaymentStatus.REQUIRES_ACTION"
        class="status-description"
      >
        Estamos esperando la confirmación del pago. Actualizaremos el estado automáticamente.
      </p>
      <p *ngIf="paymentStatus === PaymentStatus.SUCCEEDED" class="status-description">
        Pago confirmado. Estamos redirigiéndote a tu panel.
      </p>
      <p *ngIf="paymentStatus === PaymentStatus.CANCELED" class="status-description">
        El pago fue cancelado. Puedes intentar nuevamente desde tu historial.
      </p>

      <div *ngIf="paymentStatus === PaymentStatus.FAILED && paymentMetadata" class="payment-error-details">
        <h4>Detalle del error del pago</h4>
        <dl>
          <ng-container *ngFor="let entry of getPaymentMetadataEntries()">
            <dt>{{ entry.key }}</dt>
            <dd>{{ entry.value }}</dd>
          </ng-container>
        </dl>
      </div>
    </div>

    <!-- Contenido del formulario -->
    <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()" class="appointment-form">
      <!-- Paso 1: Selección de Servicio -->
      <app-service-selection
        *ngIf="currentStep === 1"
        [services]="services"
        [serviceControl]="serviceControl"
        [isLoading]="isLoading"
        [error]="error"
        (serviceChange)="onServiceChange($event)"
      ></app-service-selection>

      <!-- Paso 2: Selección de Fecha -->
      <app-date-selection
        *ngIf="currentStep === 2"
        [dateControl]="dateControl"
        [minDate]="minDate"
        [dayFilter]="dayFilter"
        [isLoading]="isLoading || isRecalculatingAvailability"
        [error]="error"
      ></app-date-selection>

      <div *ngIf="isRecalculatingAvailability" class="recalculating-loader">
        <i class="material-icons loading-icon spin">autorenew</i>
        <span>Recalculando disponibilidad para la fecha seleccionada...</span>
      </div>

      <div
        *ngIf="!isLoading && !isRecalculatingAvailability && availabilityEmpty"
        class="empty-availability"
        role="status"
      >
        <i class="material-icons">event_busy</i>
        <div>
          <p class="title">No hay fechas disponibles para esta especialidad.</p>
          <p class="subtitle">Prueba seleccionando otra fecha o servicio.</p>
        </div>
      </div>

      <!-- Paso 3: Selección de Hora -->
      <app-time-selection
        *ngIf="currentStep === 3"
        [timeControl]="timeControl"
        [availableTimeSlots]="availableTimeSlots"
        [isLoading]="isLoading || isRecalculatingAvailability"
        [error]="error"
      ></app-time-selection>

      <!-- Paso 4: Selección de Obra Social (este paso solo sale si el usuario tiene mas de 2 obras sociales) -->
      <app-health-insurance-selection
        *ngIf="currentStep === 4 && totalSteps === 5"
        [healthInsurances]="healthInsurances"
        [healthInsuranceControl]="healthInsuranceControl"
        [error]="error"
        (insuranceChange)="healthInsuranceControl.setValue($event)"
      ></app-health-insurance-selection>

      <!-- Paso 4 o 5: Resumen y Confirmación -->
      <app-appointment-summary
        *ngIf="(currentStep === 4 && totalSteps === 4) || (currentStep === 5 && totalSteps === 5)"
        [reasonControl]="reasonControl"
        [customReasonControl]="customReasonControl"
        [termsControl]="termsControl"
        [reasonOptions]="reasonOptions"
        [showCustomReason]="showCustomReason"
        [serviceIcon]="getServiceIcon(appointmentForm.get('service')?.value)"
        [serviceName]="getServiceName(appointmentForm.get('service')?.value)"
        [servicePrice]="getSelectedServicePrice()"
        [formattedDate]="formatDate(appointmentForm.get('appointmentDate')?.value)"
        [selectedTime]="appointmentForm.get('appointmentTime')?.value"
        [reasonText]="getReasonText()"
        (reasonChange)="onReasonChange($event)"
      ></app-appointment-summary>

      <!-- Botones de navegación -->
      <app-navigation-buttons
        [currentStep]="currentStep"
        [totalSteps]="totalSteps"
        [isStepValid]="isStepValid(currentStep)"
        [isFormValid]="appointmentForm.valid"
        [isLoading]="isLoading"
        [buttonState]="buttonState"
        (backClick)="prevStep()"
        (nextClick)="nextStep()"
        (buttonHover)="onButtonHover($event)"
      ></app-navigation-buttons>
    </form>
  </div>
</div>