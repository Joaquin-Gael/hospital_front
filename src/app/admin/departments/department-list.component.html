<div class="department-section">
  <app-section-header
    title="Gestión de Departamentos"
    subtitle="Administra los departamentos del sistema médico"
    icon="business"
    [actions]="headerActions">
  </app-section-header>

  <!-- Error global (fuera del formulario) -->
  @if (error && !showForm) {
    <app-error-message 
      [message]="error" 
      (close)="error = null">
    </app-error-message>
  }

  @if (showForm) {
    <div class="department-section__form-container">
      <!-- Error dentro del formulario -->
      @if (error) {
        <app-error-message 
          [message]="error" 
          (close)="error = null">
        </app-error-message>
      }
      
      <app-entity-form
        [fields]="formFields"
        [initialData]="formInitialData"
        [title]="formMode === 'create' ? 'Nuevo Departamento' : 'Editar Departamento'"
        [submitLabel]="formMode === 'create' ? 'Crear' : 'Actualizar'"
        [loading]="formLoading"
        (formSubmit)="onFormSubmit($event)"
        (formCancel)="onFormCancel()">
      </app-entity-form>
    </div>
  } @else {
    @if (loading && departments.length === 0) {
      <!-- Solo mostrar spinner si no hay datos aún -->
      <app-loading-spinner [message]="'Cargando departamentos...'"></app-loading-spinner>
    } @else {
      <div class="department-section__table-container">
        <app-data-table
          [data]="departments"
          [columns]="tableColumns"
          [loading]="loading"
          [searchEnabled]="true"
          [pagination]="true"
          [error]="error"
          [actions]="{
            view: true,
            edit: true,
            delete: true,
            ban: false,
            unban: false,
            download: false
          }"
          (edit)="onEdit($event)"
          (delete)="onDelete($event)"
          (view)="onView($event)"
          (retry)="onRetry()">
        </app-data-table>
      </div>
    }
  }

  <!-- View Dialog -->
  <app-view-dialog
    [isOpen]="viewDialogOpen"
    [item]="viewDialogData"
    [columns]="viewDialogColumns"
    [title]="viewDialogTitle"
    (close)="closeViewDialog()">
  </app-view-dialog>
</div>